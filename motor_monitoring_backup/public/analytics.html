<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced MQTT Motor Control Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background: linear-gradient(45deg, #4CAF50, #2e7d32);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .header-content {
            text-align: center;
            margin: 0 auto;
            max-width: 800px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            color: #cccccc;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* FIXED: Better aligned controls grid */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            align-items: start; /* Changed from 'end' to 'start' for better alignment */
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%; /* Ensure equal height */
        }

        .control-group label {
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
            min-height: 24px; /* Consistent label height */
        }

        .control-group input,
        .control-group select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 14px;
            min-height: 48px; /* Consistent input height */
        }

        .control-group select {
            background: #000000;
            color: #ffffff;
        }

        .control-group select option {
            background: #000000;
            color: #ffffff;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .date-presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            min-height: 40px; /* Consistent preset area height */
        }

        .preset-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .preset-btn:hover,
        .preset-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #1565C0);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #2e7d32);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #00ff88;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            color: #cccccc;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            text-align: center;
            color: #00ff88;
            font-weight: bold;
        }

        .correlation-matrix {
            margin-bottom: 30px;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .correlation-table th,
        .correlation-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .correlation-table th {
            background: rgba(0, 255, 136, 0.1);
            font-weight: bold;
            color: #00ff88;
        }

        .correlation-cell {
            font-weight: bold;
            border-radius: 4px;
        }

        .correlation-strong-positive {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .correlation-moderate-positive {
            background: rgba(255, 193, 7, 0.3);
            color: #FFC107;
        }

        .correlation-weak {
            background: rgba(158, 158, 158, 0.3);
            color: #9E9E9E;
        }

        .correlation-moderate-negative {
            background: rgba(255, 152, 0, 0.3);
            color: #FF9800;
        }

        .correlation-strong-negative {
            background: rgba(244, 67, 54, 0.3);
            color: #F44336;
        }

        .data-table-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.4em;
            color: #00ff88;
            font-weight: bold;
        }

        .pagination-info {
            color: #cccccc;
            font-size: 14px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .data-table th {
            background: rgba(0, 255, 136, 0.1);
            font-weight: bold;
            color: #00ff88;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pagination button:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #00ff88;
            color: #000000;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #00ff88;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .export-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .export-section h3 {
            color: #00ff88;
            margin-bottom: 15px;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .status-loading {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .status-success {
            background: linear-gradient(45deg, #4CAF50, #2e7d32);
            color: white;
        }

        .status-error {
            background: linear-gradient(45deg, #F44336, #c62828);
            color: white;
        }

        @media (max-width: 1024px) {
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-overview {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .back-btn {
                position: static;
                margin-bottom: 20px;
            }

            .container {
                padding: 20px 15px;
            }

            .data-table {
                font-size: 12px;
            }

            .export-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00cc66;
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="statusIndicator" style="display: none;"></div>

    <div class="header">
        <a href="/" class="back-btn">← Back to Dashboard</a>
        <div class="header-content">
            <h1>Motor Analytics Dashboard</h1>
            <p>Professional Data Analysis & Statistical Insights with Current Monitoring</p>
        </div>
    </div>

    <div class="container">
        <!-- FIXED: Better aligned Controls Section -->
        <div class="controls-section">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="startDate">Start Date</label>
                    <input type="datetime-local" id="startDate">
                    <div class="date-presets">
                        <button class="preset-btn" onclick="setDatePreset('24h')">24 Hours</button>
                        <button class="preset-btn" onclick="setDatePreset('7d')">7 Days</button>
                        <button class="preset-btn" onclick="setDatePreset('30d')">30 Days</button>
                    </div>
                </div>

                <div class="control-group">
                    <label for="endDate">End Date</label>
                    <input type="datetime-local" id="endDate">
                    <div style="min-height: 40px;"></div> <!-- Spacer for alignment -->
                </div>

                <div class="control-group">
                    <label for="aggregation">Data Aggregation</label>
                    <select id="aggregation">
                        <option value="raw">Raw Data</option>
                        <option value="hourly">Hourly Average</option>
                        <option value="daily">Daily Average</option>
                        <option value="weekly">Weekly Average</option>
                    </select>
                    <div style="min-height: 40px;"></div> <!-- Spacer for alignment -->
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="loadAnalytics()">Analyze Data</button>
                <button class="btn btn-secondary" onclick="refreshAnalytics()">Refresh</button>
                <button class="btn btn-success" onclick="exportData('csv')">Export CSV</button>
            </div>
        </div>

        <!-- Enhanced Statistics Overview with Current Data -->
        <div class="stats-overview" id="statsOverview">
            <div class="stat-card">
                <div class="stat-value" id="totalReadings">--</div>
                <div class="stat-label">Total Readings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgTemperature">--°C</div>
                <div class="stat-label">Avg Temperature</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgVibration">--</div>
                <div class="stat-label">Avg Vibration (m/s²)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgMotorSpeed">--%</div>
                <div class="stat-label">Avg Motor Speed</div>
            </div>
            <!-- Current monitoring statistics -->
            <div class="stat-card">
                <div class="stat-value" id="avgMotorCurrent">-- A</div>
                <div class="stat-label">Avg Motor Current</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgMotorPower">-- W</div>
                <div class="stat-label">Avg Motor Power</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="maxMotorCurrent">-- A</div>
                <div class="stat-label">Peak Current</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEnergyConsumed">-- Ah</div>
                <div class="stat-label">Total Energy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="faultRate">--%</div>
                <div class="stat-label">Fault Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentFaultRate">--%</div>
                <div class="stat-label">Current Fault Rate</div>
            </div>
        </div>

        <!-- Enhanced Charts Section -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Temperature vs Motor Current Correlation</div>
                <canvas id="tempCurrentChart" width="400" height="300"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Motor Power Consumption Analysis (P = V × I)</div>
                <canvas id="powerChart" width="400" height="300"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Vibration vs Current Pattern</div>
                <canvas id="vibCurrentChart" width="400" height="300"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Motor Efficiency Analysis</div>
                <canvas id="efficiencyChart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Enhanced Correlation Matrix -->
        <div class="chart-container full-width correlation-matrix">
            <div class="chart-title">Enhanced Sensor Correlation Matrix (Including Current)</div>
            <div id="correlationMatrix">
                <div class="loading">Loading correlation data...</div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table-section">
            <div class="table-header">
                <div class="table-title">Detailed Analytics Data</div>
                <div class="pagination-info" id="paginationInfo">--</div>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead id="tableHeader">
                        <tr>
                            <th>Timestamp</th>
                            <th>Temperature (°C)</th>
                            <th>Humidity (%)</th>
                            <th>Vibration (m/s²)</th>
                            <th>Motor Speed (%)</th>
                            <th>Current (A)</th>
                            <th>Power (W)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="8" class="loading">Loading analytics data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h3>Data Export Options</h3>
            <p>Export your enhanced analytics data including current monitoring for further analysis</p>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportData('csv')">Export as CSV</button>
                <button class="btn btn-primary" onclick="exportData('json')">Export as JSON</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = [];
        let currentPage = 1;
        let totalPages = 1;
        let charts = {};

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDateInputs();
            loadAnalytics();
            
            console.log('Enhanced Analytics Dashboard with Current Monitoring initialized');
            console.log('Professional motor monitoring analytics with current sensing ready');
            console.log('Power calculation: P = V × I (12V assumed)');
        });

        // FIXED: Initialize date inputs with proper timezone handling
        function initializeDateInputs() {
            const now = new Date();
            const yesterday = new Date(now - 24 * 60 * 60 * 1000);
            
            // Use local timezone consistently
            const endDateLocal = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            const startDateLocal = new Date(yesterday.getTime() - (yesterday.getTimezoneOffset() * 60000));
            
            document.getElementById('endDate').value = endDateLocal.toISOString().slice(0, 16);
            document.getElementById('startDate').value = startDateLocal.toISOString().slice(0, 16);
            
            console.log('Date inputs initialized with local timezone');
            console.log('Start:', startDateLocal.toISOString());
            console.log('End:', endDateLocal.toISOString());
        }

        // FIXED: Set date presets with proper timezone handling
        function setDatePreset(preset) {
            const now = new Date();
            const endDateLocal = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
            let startDateLocal;

            switch(preset) {
                case '24h':
                    const yesterday = new Date(now - 24 * 60 * 60 * 1000);
                    startDateLocal = new Date(yesterday.getTime() - (yesterday.getTimezoneOffset() * 60000));
                    break;
                case '7d':
                    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    startDateLocal = new Date(weekAgo.getTime() - (weekAgo.getTimezoneOffset() * 60000));
                    break;
                case '30d':
                    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    startDateLocal = new Date(monthAgo.getTime() - (monthAgo.getTimezoneOffset() * 60000));
                    break;
            }

            document.getElementById('startDate').value = startDateLocal.toISOString().slice(0, 16);
            document.getElementById('endDate').value = endDateLocal.toISOString().slice(0, 16);

            // Update active preset button
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            console.log(`Date preset set to ${preset}`);
            console.log('Start:', startDateLocal.toISOString());
            console.log('End:', endDateLocal.toISOString());
        }

        // Main analytics loading function
        async function loadAnalytics() {
            showStatus('Loading enhanced analytics data...', 'loading');
            
            try {
                // Load statistics
                await loadStatistics();
                
                // Load charts data
                await loadChartsData();
                
                // Load correlation matrix
                await loadCorrelationMatrix();
                
                // Load data table
                await loadDataTable();
                
                showStatus('Enhanced analytics loaded successfully!', 'success');
                setTimeout(() => hideStatus(), 2000);
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showStatus('Error loading analytics data', 'error');
                setTimeout(() => hideStatus(), 3000);
            }
        }

        // Load enhanced statistics overview
        async function loadStatistics() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                console.log('Loading statistics for date range:', startDate, 'to', endDate);
                
                const response = await fetch(`/api/analytics/stats?startDate=${startDate}&endDate=${endDate}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const stats = await response.json();
                
                // Update statistics display
                document.getElementById('totalReadings').textContent = stats.totalReadings || 0;
                document.getElementById('avgTemperature').textContent = `${(stats.avgTemperature || 0).toFixed(1)}°C`;
                document.getElementById('avgVibration').textContent = (stats.avgVibration || 0).toFixed(3);
                document.getElementById('avgMotorSpeed').textContent = `${Math.round(stats.avgMotorSpeed || 0)}%`;
                
                // Current monitoring statistics
                document.getElementById('avgMotorCurrent').textContent = `${(stats.avgMotorCurrent || 0).toFixed(2)} A`;
                document.getElementById('avgMotorPower').textContent = `${(stats.avgMotorPower || 0).toFixed(1)} W`;
                document.getElementById('maxMotorCurrent').textContent = `${(stats.maxMotorCurrent || 0).toFixed(2)} A`;
                document.getElementById('totalEnergyConsumed').textContent = `${(stats.totalEnergyConsumed || 0).toFixed(3)} Ah`;
                
                document.getElementById('faultRate').textContent = `${(stats.temperatureFaultRate || 0).toFixed(1)}%`;
                document.getElementById('currentFaultRate').textContent = `${(stats.currentFaultRate || 0).toFixed(1)}%`;
                
                console.log('Enhanced statistics with current data loaded:', stats);
                console.log('Power formula confirmed: P = V × I (12V motor assumed)');
                
            } catch (error) {
                console.error('Error loading statistics:', error);
                // Set default values on error
                document.getElementById('totalReadings').textContent = '0';
                document.getElementById('avgTemperature').textContent = '0.0°C';
                document.getElementById('avgVibration').textContent = '0.000';
                document.getElementById('avgMotorSpeed').textContent = '0%';
                document.getElementById('avgMotorCurrent').textContent = '0.00 A';
                document.getElementById('avgMotorPower').textContent = '0.0 W';
                document.getElementById('maxMotorCurrent').textContent = '0.00 A';
                document.getElementById('totalEnergyConsumed').textContent = '0.000 Ah';
                document.getElementById('faultRate').textContent = '0.0%';
                document.getElementById('currentFaultRate').textContent = '0.0%';
                throw error;
            }
        }

        // Load enhanced charts data
        async function loadChartsData() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const aggregation = document.getElementById('aggregation').value;
                
                console.log('Loading charts data for:', startDate, 'to', endDate, '(', aggregation, ')');
                
                const response = await fetch(`/api/analytics/data?startDate=${startDate}&endDate=${endDate}&aggregation=${aggregation}&limit=100`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                currentData = result.data || [];
                
                // Create enhanced charts even with empty data
                createTempCurrentChart(currentData);
                createPowerChart(currentData);
                createVibCurrentChart(currentData);
                createEfficiencyChart(currentData);
                
                console.log('Enhanced charts data with current monitoring loaded:', result);
                
            } catch (error) {
                console.error('Error loading charts data:', error);
                // Create charts with empty data
                currentData = [];
                createTempCurrentChart([]);
                createPowerChart([]);
                createVibCurrentChart([]);
                createEfficiencyChart([]);
                throw error;
            }
        }

        // Load enhanced correlation matrix
        async function loadCorrelationMatrix() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                const response = await fetch(`/api/analytics/correlations?startDate=${startDate}&endDate=${endDate}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                displayEnhancedCorrelationMatrix(result.correlations);
                console.log('Enhanced correlation matrix with current data loaded:', result);
                
            } catch (error) {
                console.error('Error loading correlation matrix:', error);
                document.getElementById('correlationMatrix').innerHTML = 
                    '<div class="error">Error loading correlation data</div>';
            }
        }

        // Enhanced charts creation functions

        // Create temperature vs current chart
        function createTempCurrentChart(data) {
            const ctx = document.getElementById('tempCurrentChart').getContext('2d');
            
            if (charts.tempCurrent) {
                charts.tempCurrent.destroy();
            }
            
            const chartData = {
                datasets: [{
                    label: 'Temp vs Current',
                    data: data.map(d => ({
                        x: d.temperature || d.avg_temperature || 0,
                        y: d.motor_current || d.avg_motor_current || 0
                    })),
                    backgroundColor: 'rgba(255, 235, 59, 0.6)',
                    borderColor: '#ffeb3b',
                    borderWidth: 1
                }]
            };
            
            charts.tempCurrent = new Chart(ctx, {
                type: 'scatter',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' },
                            title: { display: true, text: 'Temperature (°C)', color: '#ffffff' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' },
                            title: { display: true, text: 'Current (A)', color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // FIXED: Create power consumption chart with proper formula documentation
        function createPowerChart(data) {
            const ctx = document.getElementById('powerChart').getContext('2d');
            
            if (charts.power) {
                charts.power.destroy();
            }
            
            charts.power = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((d, index) => index + 1),
                    datasets: [{
                        label: 'Motor Power (W) - P = V × I',
                        data: data.map(d => d.motor_power || d.avg_motor_power || 0),
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } },
                        tooltip: {
                            callbacks: {
                                footer: function(context) {
                                    return 'Formula: P = V × I (12V assumed)';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' },
                            title: { display: true, text: 'Power (W)', color: '#ffffff' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // Create vibration vs current chart
        function createVibCurrentChart(data) {
            const ctx = document.getElementById('vibCurrentChart').getContext('2d');
            
            if (charts.vibCurrent) {
                charts.vibCurrent.destroy();
            }
            
            const chartData = {
                datasets: [{
                    label: 'Vibration vs Current',
                    data: data.map(d => ({
                        x: d.vibration || d.avg_vibration || 0,
                        y: d.motor_current || d.avg_motor_current || 0
                    })),
                    backgroundColor: 'rgba(156, 39, 176, 0.6)',
                    borderColor: '#9c27b0',
                    borderWidth: 1
                }]
            };
            
            charts.vibCurrent = new Chart(ctx, {
                type: 'scatter',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' },
                            title: { display: true, text: 'Vibration (m/s²)', color: '#ffffff' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' },
                            title: { display: true, text: 'Current (A)', color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // Create efficiency analysis chart
        function createEfficiencyChart(data) {
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            
            if (charts.efficiency) {
                charts.efficiency.destroy();
            }
            
            // Calculate efficiency (Speed/Power ratio)
            const efficiencyData = data.map(d => {
                const speed = d.motor_speed || d.avg_motor_speed || 0;
                const power = d.motor_power || d.avg_motor_power || 0;
                return power > 0 ? speed / power : 0;
            });
            
            charts.efficiency = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((d, index) => index + 1),
                    datasets: [{
                        label: 'Motor Efficiency (Speed/Power)',
                        data: efficiencyData,
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' },
                            title: { display: true, text: 'Efficiency Ratio', color: '#ffffff' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // Load data table
        async function loadDataTable(page = 1) {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const aggregation = document.getElementById('aggregation').value;
                
                console.log('Loading data table page', page, 'for:', startDate, 'to', endDate);
                
                const response = await fetch(`/api/analytics/data?startDate=${startDate}&endDate=${endDate}&aggregation=${aggregation}&page=${page}&limit=20`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                displayEnhancedDataTable(result.data || [], result.pagination || {});
                updatePagination(result.pagination || {});
                
                console.log('Enhanced data table loaded:', result);
                
            } catch (error) {
                console.error('Error loading data table:', error);
                document.getElementById('dataTableBody').innerHTML = 
                    '<tr><td colspan="8" class="error">Error loading table data</td></tr>';
            }
        }

        // Display enhanced correlation matrix
        function displayEnhancedCorrelationMatrix(correlations) {
            if (!correlations) {
                document.getElementById('correlationMatrix').innerHTML = 
                    '<div class="error">No correlation data available</div>';
                return;
            }

            const sensors = ['temperature', 'humidity', 'vibration', 'motor_speed', 'motor_current', 'motor_power'];
            const sensorLabels = {
                temperature: 'Temperature',
                humidity: 'Humidity',
                vibration: 'Vibration',
                motor_speed: 'Motor Speed',
                motor_current: 'Motor Current',
                motor_power: 'Motor Power'
            };

            let html = '<table class="correlation-table"><thead><tr><th></th>';
            
            // Header row
            sensors.forEach(sensor => {
                html += `<th>${sensorLabels[sensor]}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Data rows
            sensors.forEach(sensor1 => {
                html += `<tr><th>${sensorLabels[sensor1]}</th>`;
                sensors.forEach(sensor2 => {
                    const correlation = correlations[sensor1] && correlations[sensor1][sensor2] 
                        ? correlations[sensor1][sensor2] 
                        : 0;
                    
                    const absCorr = Math.abs(correlation);
                    let className = 'correlation-weak';
                    
                    if (absCorr >= 0.7) {
                        className = correlation > 0 ? 'correlation-strong-positive' : 'correlation-strong-negative';
                    } else if (absCorr >= 0.3) {
                        className = correlation > 0 ? 'correlation-moderate-positive' : 'correlation-moderate-negative';
                    }
                    
                    html += `<td class="correlation-cell ${className}">${correlation.toFixed(3)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('correlationMatrix').innerHTML = html;
        }

        // FIXED: Display enhanced data table with proper timestamp handling
        function displayEnhancedDataTable(data, pagination) {
            const tableBody = document.getElementById('dataTableBody');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No data available for the selected time range</td></tr>';
                return;
            }

            let html = '';
            data.forEach(row => {
                // FIXED: Proper timestamp handling without timezone issues
                let timestamp = 'N/A';
                if (row.created_at) {
                    const date = new Date(row.created_at);
                    timestamp = date.toLocaleString(); // Use local timezone for display
                } else if (row.timestamp) {
                    timestamp = row.timestamp;
                }
                
                html += `
                    <tr>
                        <td>${timestamp}</td>
                        <td>${(row.temperature || row.avg_temperature || 0).toFixed(1)}</td>
                        <td>${(row.humidity || row.avg_humidity || 0).toFixed(1)}</td>
                        <td>${(row.vibration || row.avg_vibration || 0).toFixed(3)}</td>
                        <td>${Math.round(row.motor_speed || row.avg_motor_speed || 0)}</td>
                        <td>${(row.motor_current || row.avg_motor_current || 0).toFixed(2)}</td>
                        <td>${(row.motor_power || row.avg_motor_power || 0).toFixed(1)}</td>
                        <td>${row.temp_status || row.vib_status || row.current_status || 'Normal'}</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;

            // Update pagination info
            document.getElementById('paginationInfo').textContent = 
                `Page ${pagination.page || 1} of ${pagination.pages || 1} (${pagination.total || 0} total records)`;
        }

        // Update pagination controls
        function updatePagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            currentPage = pagination.page || 1;
            totalPages = pagination.pages || 1;

            let html = '';

            // Previous button
            html += `<button onclick="loadDataTable(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>Previous</button>`;

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<button onclick="loadDataTable(1)">1</button>`;
                if (startPage > 2) html += '<span>...</span>';
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="loadDataTable(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span>...</span>';
                html += `<button onclick="loadDataTable(${totalPages})">${totalPages}</button>`;
            }

            // Next button
            html += `<button onclick="loadDataTable(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>`;

            paginationDiv.innerHTML = html;
        }

        // Refresh analytics
        function refreshAnalytics() {
            loadAnalytics();
        }

        // Enhanced export data
        async function exportData(format) {
            try {
                showStatus(`Exporting enhanced data as ${format.toUpperCase()}...`, 'loading');
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                console.log('Exporting data from', startDate, 'to', endDate, 'as', format);
                
                const url = `/api/analytics/export?startDate=${startDate}&endDate=${endDate}&format=${format}`;
                
                // Create a temporary link and click it to download
                const link = document.createElement('a');
                link.href = url;
                link.download = `motor_analytics_with_current_${new Date().toISOString().split('T')[0]}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus(`Enhanced data exported successfully as ${format.toUpperCase()}!`, 'success');
                setTimeout(() => hideStatus(), 2000);
                
            } catch (error) {
                console.error(`Error exporting ${format}:`, error);
                showStatus(`Export failed: ${error.message}`, 'error');
                setTimeout(() => hideStatus(), 3000);
            }
        }

        // Status indicator functions
        function showStatus(message, type) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `status-indicator status-${type}`;
            indicator.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusIndicator').style.display = 'none';
        }

        console.log('Enhanced Analytics Dashboard with Current Monitoring Script Loaded');
        console.log('Professional motor monitoring analytics with current sensing ready');
        console.log('Features: Statistics, Charts, Correlations, Current Analysis, Data Export');
        console.log('Current sensor integration: ACS712 Hall Effect Sensor');
        console.log('Power monitoring: Real-time current, power, and energy analysis');
        console.log('Power formula: P = V × I (12V motor voltage assumed)');
        console.log('Timezone: Fixed to use local timezone consistently');
    </script>
</body>
</html>